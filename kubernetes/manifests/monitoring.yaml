apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: antidetect-api
  labels:
    app: antidetect-api
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: antidetect-api
  endpoints:
  - port: metrics
    interval: 15s
    path: /metrics
    scheme: http
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: browser-pool
  labels:
    app: browser-pool
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: browser-pool
  endpoints:
  - port: metrics
    interval: 15s
    path: /metrics
    scheme: http
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: antidetect-alerts
  labels:
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  - name: antidetect.rules
    interval: 30s
    rules:
    # High CPU usage
    - alert: HighPodCPU
      expr: |
        sum(rate(container_cpu_usage_seconds_total{namespace="antidetect", container!=""}[5m])) by (pod)
        /
        sum(container_spec_cpu_quota{namespace="antidetect", container!=""}/container_spec_cpu_period{namespace="antidetect", container!=""}) by (pod)
        > 0.9
      for: 5m
      labels:
        severity: warning
        component: "{{ $labels.pod }}"
      annotations:
        summary: "Pod {{ $labels.pod }} high CPU usage"
        description: "CPU usage is {{ $value | humanizePercentage }} (threshold: 90%)"

    # High memory usage
    - alert: HighPodMemory
      expr: |
        sum(container_memory_working_set_bytes{namespace="antidetect", container!=""}) by (pod)
        /
        sum(container_spec_memory_limit_bytes{namespace="antidetect", container!=""}) by (pod)
        > 0.9
      for: 5m
      labels:
        severity: warning
        component: "{{ $labels.pod }}"
      annotations:
        summary: "Pod {{ $labels.pod }} high memory usage"
        description: "Memory usage is {{ $value | humanizePercentage }} (threshold: 90%)"

    # Pod restarts
    - alert: PodRestartingTooOften
      expr: |
        rate(kube_pod_container_status_restarts_total{namespace="antidetect"}[15m]) > 0.1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.pod }} restarting too often"
        description: "Pod has restarted {{ $value }} times in the last 15 minutes"

    # High API error rate
    - alert: HighAPIErrorRate
      expr: |
        sum(rate(http_requests_total{namespace="antidetect", status=~"5.."}[5m]))
        /
        sum(rate(http_requests_total{namespace="antidetect"}[5m]))
        > 0.05
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "High API error rate detected"
        description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

    # High API latency
    - alert: HighAPILatency
      expr: |
        histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{namespace="antidetect"}[5m])) by (le))
        > 1.0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High API latency detected"
        description: "95th percentile latency is {{ $value }}s (threshold: 1s)"

    # Detection score drop
    - alert: DetectionScoreDrop
      expr: |
        avg(detection_score{namespace="antidetect"}) < 9.0
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Detection score dropped below 9.0"
        description: "Current average score: {{ $value }}"

    # Browser pool capacity
    - alert: BrowserPoolNearCapacity
      expr: |
        sum(active_browser_sessions{namespace="antidetect"})
        /
        (sum(kube_deployment_spec_replicas{namespace="antidetect", deployment="browser-pool"}) * 10)
        > 0.9
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Browser pool near capacity"
        description: "Utilization is {{ $value | humanizePercentage }} (threshold: 90%)"

    # Profile rotation failures
    - alert: HighProfileRotationFailures
      expr: |
        rate(profile_rotation_failures_total{namespace="antidetect"}[15m]) > 0.1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High profile rotation failure rate"
        description: "Failure rate: {{ $value }} per second"

    # Redis connection issues
    - alert: RedisConnectionErrors
      expr: |
        rate(redis_errors_total{namespace="antidetect"}[5m]) > 0.1
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "Redis connection errors detected"
        description: "Error rate: {{ $value }} per second"

    # PostgreSQL connection issues
    - alert: PostgresConnectionErrors
      expr: |
        rate(postgres_errors_total{namespace="antidetect"}[5m]) > 0.1
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "PostgreSQL connection errors detected"
        description: "Error rate: {{ $value }} per second"
---
# Grafana Dashboard ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: antidetect-dashboard
  labels:
    grafana_dashboard: "1"
data:
  antidetect-overview.json: |
    {
      "dashboard": {
        "title": "Anti-Detect Browser - Overview",
        "panels": [
          {
            "title": "Active Browser Sessions",
            "targets": [
              {
                "expr": "sum(active_browser_sessions{namespace=\"antidetect\"})"
              }
            ]
          },
          {
            "title": "API Request Rate",
            "targets": [
              {
                "expr": "sum(rate(http_requests_total{namespace=\"antidetect\"}[5m]))"
              }
            ]
          },
          {
            "title": "Detection Score",
            "targets": [
              {
                "expr": "avg(detection_score{namespace=\"antidetect\"})"
              }
            ]
          },
          {
            "title": "Pod CPU Usage",
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"antidetect\"}[5m])) by (pod)"
              }
            ]
          },
          {
            "title": "Pod Memory Usage",
            "targets": [
              {
                "expr": "sum(container_memory_working_set_bytes{namespace=\"antidetect\"}) by (pod)"
              }
            ]
          }
        ]
      }
    }
