# ==================================
# ConfigMap Configuration
# Non-sensitive application configuration
# ==================================

---
# Application ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: antidetect
  labels:
    app: browser
    tier: application
data:
  # Application settings
  node-env: "production"
  port: "3000"
  log-level: "info"

  # JWT settings
  jwt-expires-in: "24h"

  # Authentication
  enable-auth: "true"

  # CORS settings
  cors-origin: "*"

  # Browser settings
  max-concurrent-browsers: "50"
  browser-timeout: "300000"
  headless: "true"

  # Performance settings
  enable-cache: "true"
  cache-ttl: "3600"

  # Rate limiting
  rate-limit-window: "900000"
  rate-limit-max: "100"

  # Monitoring
  enable-metrics: "true"
  metrics-port: "9090"

---
# Nginx ConfigMap (if using Nginx as reverse proxy)
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: antidetect
  labels:
    app: nginx
    tier: proxy
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
      worker_connections 4096;
      use epoll;
      multi_accept on;
    }

    http {
      include /etc/nginx/mime.types;
      default_type application/octet-stream;

      log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

      access_log /var/log/nginx/access.log main;

      sendfile on;
      tcp_nopush on;
      tcp_nodelay on;
      keepalive_timeout 65;
      types_hash_max_size 2048;
      client_max_body_size 100M;

      gzip on;
      gzip_disable "msie6";
      gzip_vary on;
      gzip_proxied any;
      gzip_comp_level 6;
      gzip_types text/plain text/css text/xml text/javascript
                 application/json application/javascript application/xml+rss;

      # Rate limiting
      limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
      limit_req_status 429;

      # Upstream browser pool
      upstream browser_pool {
        least_conn;
        server browser-pool-internal:3000 max_fails=3 fail_timeout=30s;
        keepalive 32;
      }

      server {
        listen 80;
        server_name _;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        location / {
          limit_req zone=api_limit burst=20 nodelay;

          proxy_pass http://browser_pool;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection 'upgrade';
          proxy_set_header Host $host;
          proxy_cache_bypass $http_upgrade;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;

          # Timeouts
          proxy_connect_timeout 60s;
          proxy_send_timeout 300s;
          proxy_read_timeout 300s;
        }

        location /health {
          access_log off;
          proxy_pass http://browser_pool/health;
        }

        location /metrics {
          access_log off;
          proxy_pass http://browser_pool/metrics;
        }
      }
    }

---
# Monitoring ConfigMap (Prometheus configuration)
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: antidetect
  labels:
    app: prometheus
    tier: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
    - job_name: 'browser-pool'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - antidetect
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
